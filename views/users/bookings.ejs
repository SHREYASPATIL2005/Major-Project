<%- layout("layouts/boilerplate") %>

<div class="container mt-5">
    <h1 class="mb-4">Your Bookings</h1>

    <% if (bookings && bookings.length > 0) { %>
        <div class="listings-bookings">
            <% for (let booking of bookings) { 
                const nights = Math.ceil((new Date(booking.checkOut) - new Date(booking.checkIn)) / (1000*60*60*24));
            %>
                <div class="booking-card shadow-sm mb-4 d-flex flex-column flex-md-row">
                    <div class="booking-image">
                        <% if (booking.listing.images && booking.listing.images.length > 0) { %>
                            <img src="<%= booking.listing.images[0].url %>" alt="<%= booking.listing.title %>" />
                        <% } else if (booking.listing.image && booking.listing.image.url) { %>
                            <img src="<%= booking.listing.image.url %>" alt="<%= booking.listing.title %>" />
                        <% } else { %>
                            <div class="placeholder">No image</div>
                        <% } %>
                    </div>
                    <div class="booking-info flex-grow-1 p-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4 class="mb-1"><a href="/listings/<%= booking.listing._id %>"><%= booking.listing.title %></a></h4>
                                <p class="mb-1 text-muted">Hosted by <strong><%= booking.listing.owner.username %></strong> — <%= booking.listing.location %></p>
                                <p class="mb-1"><strong>Dates:</strong> <%= booking.checkIn.toLocaleDateString() %> — <%= booking.checkOut.toLocaleDateString() %> (<%= nights %> nights)</p>
                                <p class="mb-0"><strong>Total:</strong> ₹<%= booking.totalPrice.toLocaleString('en-IN') %></p>
                            </div>
                            <div class="text-end">
                                <span class="badge booking-status <%= booking.status %>"><%= booking.status.charAt(0).toUpperCase() + booking.status.slice(1) %></span>
                            </div>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <a href="/listings/<%= booking.listing._id %>" class="btn btn-primary btn-sm">View Listing</a>
                            <% if (booking.status === 'pending') { %>
                                <form action="/listings/<%= booking.listing._id %>/bookings/<%= booking._id %>/cancel" method="POST" onsubmit="return confirm('Cancel this booking?');">
                                    <button class="btn btn-outline-danger btn-sm">Cancel Booking</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>
    <% } else { %>
        <div class="alert alert-info">
            You don't have any bookings yet. <a href="/listings">Browse listings</a> to make your first booking!
        </div>
    <% } %>
</div>

<style>
.booking-card { background: #fff; border-radius: 12px; overflow: hidden; }
.booking-image { width: 100%; max-width: 320px; }
.booking-image img { width: 100%; height: 180px; object-fit: cover; display: block; }
.booking-info { min-width: 0; }
.booking-status.pending { background: #ffcf33; color: #1f1f1f; padding: .4rem .6rem; border-radius: .5rem; }
.booking-status.confirmed { background: #28a745; color: #fff; padding: .4rem .6rem; border-radius: .5rem; }
.booking-status.cancelled { background: #dc3545; color: #fff; padding: .4rem .6rem; border-radius: .5rem; }
.booking-card .placeholder { width:100%; height:180px; display:flex; align-items:center; justify-content:center; background:#f2f3f4; color:#6c757d; }
@media(min-width:768px){ .booking-card { flex-direction: row; } .booking-image img{ height:160px; } }
</style>
