<!-- views/includes/booking-card.ejs -->
<div class="card shadow-sm booking-card">
    <div class="card-body p-0">
        <div class="price-header text-center p-4">
            <div class="price-amount">₹<%= listing.price.toLocaleString('en-IN') %></div>
            <div class="price-sub">/night</div>
        </div>

        <div class="p-3">
            <% if (currUser) { %>
                <form action="/listings/<%= listing._id %>/bookings" method="POST" id="bookingForm">
                    <div class="mb-3">
                        <label for="checkIn" class="form-label small">Check-in</label>
                        <input type="date" class="form-control date-input" id="checkIn" name="checkIn" required min="<%= new Date().toISOString().split('T')[0] %>">
                    </div>
                    <div class="mb-3">
                        <label for="checkOut" class="form-label small">Check-out</label>
                        <input type="date" class="form-control date-input" id="checkOut" name="checkOut" required min="<%= new Date().toISOString().split('T')[0] %>">
                    </div>

                    <div class="price-details mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">₹<%= listing.price %> × <span id="numberOfNights">0</span> nights</div>
                            <div id="subtotal" class="fw-semibold">₹0</div>
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-bold">Total</div>
                            <div id="totalPrice" class="fw-bold">₹0</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-book w-100" id="bookNowBtn">Book Now</button>
                </form>
            <% } else { %>
                <div class="text-center py-3">
                    <p class="mb-2">Please <a href="/login">login</a> to book</p>
                    <a href="/login" class="btn btn-outline-primary btn-sm">Login</a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<style>
.booking-card { border-radius: 1rem; overflow: hidden; }
.price-header { background: linear-gradient(135deg,#2dd4bf,#06b6d4); color: #fff; display: none; }
.price-amount { font-size: 1.65rem; font-weight: 800; }
.price-sub { font-size: 0.9rem; opacity: 0.95; }
.date-input { padding: .8rem; border-radius: .6rem; border: 1px solid #e6e9ee; }
.price-details { background: #fbfcfd; padding: .75rem 1rem; border-radius: .5rem; border: 1px solid #f0f2f5; }
.btn-book { background: linear-gradient(180deg,#138f6b,#0b6f4f); color: #fff; border: none; padding: .6rem 1rem; border-radius: .5rem; font-weight: 600; }
.btn-book:hover { opacity: .95; }
.form-label.small { font-size: .85rem; color: #6b7280; }

/* Show price header inside booking card on small screens only (when sidebar collapses) */
@media (max-width: 767px) {
    .price-header { display: block; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkInInput = document.getElementById('checkIn');
    const checkOutInput = document.getElementById('checkOut');
    const numberOfNightsSpan = document.getElementById('numberOfNights');
    const subtotalSpan = document.getElementById('subtotal');
    const totalPriceSpan = document.getElementById('totalPrice');
    const pricePerNight = <%= listing.price %>;

    function updatePrice() {
        const checkIn = new Date(checkInInput.value);
        const checkOut = new Date(checkOutInput.value);
        if (checkIn && checkOut && checkOut > checkIn) {
            const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
            const total = nights * pricePerNight;
            numberOfNightsSpan.textContent = nights;
            subtotalSpan.textContent = `₹${total}`;
            totalPriceSpan.textContent = `₹${total}`;
        } else {
            numberOfNightsSpan.textContent = '0';
            subtotalSpan.textContent = '₹0';
            totalPriceSpan.textContent = '₹0';
        }
    }

    checkInInput.addEventListener('change', function() {
        const nextDay = new Date(checkInInput.value);
        nextDay.setDate(nextDay.getDate() + 1);
        checkOutInput.min = nextDay.toISOString().split('T')[0];
        updatePrice();
    });

    checkOutInput.addEventListener('change', updatePrice);
});
</script>
